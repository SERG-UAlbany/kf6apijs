<html>

<head>
    <link rel="stylesheet" type="text/css" href="bower_components/dcjs/dc.css">
    <script src="jquery.js"></script>
    <script src="kf6api.js"></script>
    <script src="bower_components/crossfilter2/crossfilter.min.js"></script>
    <script src="bower_components/d3/d3.min.js"></script>
    <script src="bower_components/dcjs/dc.min.js"></script>
    <script>
    function loginPressed() {
        var serverURL = $('#serverURL').val();
        kf6.setBaseURL(serverURL);

        var uname = $('#uname').val();
        var password = $('#password').val();
        kf6.login(uname, password, function() {
            getCommunities();
        }, function(data) {
            alert('login failed: ' + data.status);
        });
    }

    function getCommunities() {
        kf6.getCommunities(function(data) {
            $('#communities').html('');
            data.forEach(function(each) {
                var li = '';
                li += '<li>';
                li += each._community.title;
                li += '<input type="button" value="get" onclick="communityPressed(\'' + each.communityId + '\')">';
                li += '</li>';
                $('#communities').append(li);
            });
        })
    }

    function viewPressed(viewId) {
        kf6.getLinksFrom(viewId, function(links) {
            var objects = [];
            links.forEach(function(link) {
                if (link.type === 'contains') {
                    var object = gObjectsTable[link.to];
                    if (!object) {
                        console.error('object not found=' + link.to)
                        return;
                    }
                    objects.push(gObjectsTable[link.to]);
                }
            });

            //initialize counter
            gAuthors.forEach(function(author) {
                var counter = {};
                counter.notes = [];
                counter.drawings = [];
                counter.others = [];
                counter.reads = [];
                counter.modifies = [];
                author[viewId] = counter;
            });

            //count
            objects.forEach(function(object) {
                object.records.forEach(function(record) {
                    if (object.type === 'Note') {
                        object.authors.forEach(function(authorId) {
                            var counter = gAuthorsTable[authorId][viewId];
                            if (record.type === 'read') {
                                counter.reads.push(record);
                            } else if (record.type === 'modified') {
                                counter.modifies.push(record);
                            }
                        });
                    }
                });
                object.authors.forEach(function(authorId) {
                    var counter = gAuthorsTable[authorId][viewId];
                    if (object.type === 'Note') {
                        counter.notes.push(object);
                    } else if (object.type === 'Drawing') {
                        counter.drawings.push(object);
                    } else {
                        counter.others.push(object);
                    }
                });
            });

            //calc % of note read
            var numOfNotes = 0;
            objects.forEach(function(object) {
                if (object.type === 'Note') {
                    numOfNotes++;
                }
            });

            gAuthors.forEach(function(author) {
                var counter = author[viewId];
                var readinglist = {};
                counter.reads.forEach(function(read) {
                    readinglist[read.targetId] = 1;
                });
                counter.readcount = Object.keys(readinglist).length;
                counter.percentOfReading = Math.round((counter.readcount / numOfNotes) * 10000) / 100;
            });

            gAuthors.forEach(function(author) {
                var counter = author[viewId];
                var modifylist = {};
                counter.modifies.forEach(function(modify) {
                    modifylist[modify.targetId] = 1;
                });
                counter.modifycount = Object.keys(modifylist).length;
            });

            //make table
            $('#notes').html('<tr><th>Title</th><th># of Notes</th><th># of Drawings</th><th># of reads</th><th># of readnotes</th><th>% of readings</th><th># of edit</th><th># of editnotes</th></tr>');
            gAuthors.forEach(function(author) {
                var counter = author[viewId];
                var tr = '';
                tr += '<tr>';
                tr += '<td>' + author.firstName + ' ' + author.lastName + '</td>';
                tr += '<td>' + counter.notes.length + '</td>';
                tr += '<td>' + counter.drawings.length + '</td>';
                //tr += '<td>' + counter.others.length + '</td>';
                tr += '<td>' + counter.reads.length + '</td>';
                tr += '<td>' + counter.readcount + '</td>';
                tr += '<td>' + counter.percentOfReading + '</td>';
                tr += '<td>' + counter.modifies.length + '</td>';
                tr += '<td>' + counter.modifycount + '</td>';
                tr += '</tr>';
                $('#notes').append(tr);
            });
        });
    }

    function initialize(communityId, handler) {
        kf6.setCommunity(communityId);
        loadAuthors(function() {
            loadObjects(function() {
                loadRecords(function() {
                    initdc(gRecords);
                    handler();
                });
            });
        });
    }

    function communityPressed(communityId) {
        initialize(communityId, function() {
            kf6.getViews(function(data) {
                $('#views').html('<tr><th>Title</th><th></th></tr>');
                data.forEach(function(each) {
                    var tr = '';
                    tr += '<tr>';
                    tr += '<td>' + each.title + '</td>';
                    tr += '<td>';
                    tr += '<input type="button" value="get" onclick="viewPressed(\'' + each._id + '\')">';
                    tr += '</td>';
                    tr += '</tr>';
                    $('#views').append(tr);
                });
            });
        });
    }

    var gObjects;
    var gObjectsTable = {};

    function loadObjects(handler) {
        var query = {
            pagesize: 10000,
            searchMode: 'title'
        };
        kf6.getObjects(query, function(objects) {
            gObjects = objects;
            objects.forEach(function(object) {
                gObjectsTable[object._id] = object;
            });
            handler();
        });
    }

    var gAuthors;
    var gAuthorsTable = {};

    function loadAuthors(handler) {
        kf6.getAuthors(function(authors) {
            gAuthors = authors;
            authors.forEach(function(author) {
                gAuthorsTable[author._id] = author;
            });
            handler();
        });
    }

    var gRecords;

    function loadRecords(handler) {
        gObjects.forEach(function(object) {
            object.records = [];
        });
        var query = {};
        kf6.getRecords(query, function(records) {
            gRecords = records;
            records.forEach(function(record) {
                var object = gObjectsTable[record.targetId];
                if (!object) {
                    //console.error('object not found in records. id=' + record.targetId)
                    return;
                }
                object.records.push(record);
            });
            handler();
        });
    }

    function initdc(data) {
        var parseDate = d3.time.format("%Y-%m-%dT%H:%M:%S.%LZ").parse;
        data.forEach(function(d) {
            d.date = parseDate(d.timestamp);
            if (d.type === 'read') {
                d.read = 1;
            } else {
                d.read = 0;
            }
            d.total = 1;
        });

        var ndx = crossfilter(data);

        var dateDim = ndx.dimension(function(d) {
            return d.date;
        });
        var typeDim = ndx.dimension(function(d) {
            return d.type;
        });

        var minDate = dateDim.bottom(1)[0].date;
        var maxDate = dateDim.top(1)[0].date;

        //console.log(minDate);
        //console.log(maxDate);

        var readGroup = dateDim.group().reduceSum(function(d) {
            return d.read;
        });

        var hitslineChart = dc.barChart('#chart-line-hitsperday');
        hitslineChart
            .width(700).height(200)
            .dimension(dateDim)
            .group(readGroup, 'Read')
            //.renderArea(true)//for line chart
            .centerBar(true) //for line chart
            .x(d3.time.scale().domain([minDate, maxDate]))
            .legend(dc.legend().x(50).y(10).itemHeight(13).gap(5))
            .yAxisLabel('Hits per day');


        // dummy for update
        var hits = dateDim.group().reduceSum(function(d) {
            return d.total;
        });
        var dummy = dc.pieChart('#dummy');
        dummy
            .width(200).height(200)
            .dimension(dateDim)
            .group(hits)
            .innerRadius(30);
        dummy._doRedraw = function() {
            var filtered = typeDim.filter('read').top(Infinity);
            console.log('doRedraw');
            //refreshNetworks();
        };
        dummy._doRender = function() {
            console.log('doRender');
            //refreshNetworks();
        };
        dc.renderAll();
    }
    </script>
</head>

<body>
    <!-- login console -->
    <ul>
        <li>serverURL:
            <input id="serverURL" type="textfield" value="http://localhost:9000/">
        </li>
        <li>user:
            <input id="uname" type="textfield" value="yoshiaki.matsuzawa@gmail.com">
        </li>
        <li>password:
            <input id="password" type="password" value="test">
        </li>
        <li>
            <input type="button" value="Login" onclick="loginPressed()">
        </li>
    </ul>
    <!-- communities -->
    <h1>communities:</h1>
    <ul id="communities">
    </ul>
    <!-- notes -->
    <h1>views:</h1>
    <table border="1" id="views">
    </table>
    <!-- notes -->
    <h1>notes:</h1>
    <table border="1" id="notes">
    </table>    
    <br>
    <div style="width: 80%;" id="chart-line-hitsperday">
    </div>
      
</body>

</html>
